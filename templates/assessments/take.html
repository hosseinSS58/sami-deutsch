{% extends "base.html" %}
{% load i18n form_extras %}
{% block title %}{% trans "آزمون" %}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-2">
          <i class="fas fa-clipboard-check text-primary"></i>
          <h1 class="h4 m-0">{% trans "آزمون تعیین سطح" %}</h1>
        </div>
        <a href="{% url 'assessments:intro' %}" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-info-circle me-1"></i>{% trans "راهنما" %}
        </a>
      </div>

      <div x-data="quiz()" class="card border-0 shadow-sm">
        <div class="card-body p-3 p-md-4">
          <!-- Progress -->
          <div class="position-sticky top-0 bg-white pb-3" style="z-index: 5;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted">
                <span>{% trans "سوال" %}</span>
                <strong x-text="started ? current+1 : 0"></strong>
                <span class="mx-1">/</span>
                <span x-text="total"></span>
              </small>
              <small class="text-muted">
                <i class="fas fa-percent me-1"></i>
                <span x-text="progress"></span>%
              </small>
            </div>
            {% if last_batch_detail %}
            <div class="d-flex justify-content-between align-items-center mb-1">
              <div class="small text-muted">
                <span class="badge bg-secondary-subtle text-secondary border small">
                  نتیجه سطح قبلی{% if last_batch_stats and last_batch_stats.level %}: {{ last_batch_stats.level }}{% endif %}
                </span>
              </div>
              {% if last_batch_stats %}
              <div class="small text-muted">
                صحیح: {{ last_batch_stats.correct }}/{{ last_batch_stats.total }} ({{ last_batch_stats.ratio_percent }}%)
              </div>
              {% endif %}
            </div>
            <!-- Segmented bar for last batch results -->
            <div class="d-flex gap-1 mb-1">
              {% for item in last_batch_detail %}
                <div style="height:8px;flex:1;"
                     class="{% if item.correct %}bg-success{% else %}bg-danger{% endif %} rounded-1">
                </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="progress" style="height: 8px;">
              <div class="progress-bar" role="progressbar" :style="`width:${progress}%`" :aria-valuenow="progress" aria-valuemin="0" :aria-valuemax="100"></div>
            </div>
            {% endif %}
          </div>

          <form method="post" class="mt-3">
            {% csrf_token %}
            
            <!-- Batch feedback -->
            {% if last_batch_stats %}
            <div class="alert alert-info d-flex align-items-center gap-2">
              <i class="fas fa-info-circle"></i>
              <div>
                سطح {{ last_batch_stats.level }} — صحیح: {{ last_batch_stats.correct }}/{{ last_batch_stats.total }} ({{ last_batch_stats.ratio_percent }}%)
              </div>
            </div>
            {% endif %}

            <!-- Pre-start Panel: collect name/email (only when needed) -->
            <div x-show="!started && showIdentity" aria-live="polite">
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                  <div class="d-flex align-items-center gap-2 mb-3 p-2 rounded-3" style="background: var(--site-section-bg-color);">
                    <div class="text-primary">
                      <i class="fas fa-user-circle"></i>
                    </div>
                    <h2 class="h6 m-0">{% trans "اطلاعات اولیه برای شروع آزمون" %}</h2>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label d-flex align-items-center gap-1">
                        <span>{% trans "نام و نام خانوادگی" %}</span>
                        <span class="text-danger" title="required">*</span>
                      </label>
                      <div class="input-group input-group-lg">
                        <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                        {{ form.full_name|add_class:"form-control form-control-lg" }}
                      </div>
                      <div class="form-text">{% trans "لطفاً نام کامل خود را وارد کنید" %}</div>
                      <div class="text-danger small mt-1" x-show="errors.fullName">{% trans "نام را وارد کنید" %}</div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label d-flex align-items-center gap-1">
                        <span>{% trans "ایمیل" %}</span>
                        <span class="text-danger" title="required">*</span>
                      </label>
                      <div class="input-group input-group-lg">
                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                        {{ form.email|add_class:"form-control form-control-lg text-start" }}
                      </div>
                      <div class="form-text">{% trans "نمونه: name@example.com" %}</div>
                      <div class="text-danger small mt-1" x-show="errors.email">{% trans "ایمیل معتبر وارد کنید" %}</div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
                    <div class="text-muted small d-flex align-items-center gap-2">
                      <i class="fas fa-lock"></i>
                      <span>{% trans "اطلاعات شما محرمانه است و فقط برای نتیجه آزمون استفاده می‌شود." %}</span>
                    </div>
                    <button type="button" class="btn btn-primary btn-lg px-4" @click="start()">
                      <i class="fas fa-play me-1"></i>{% trans "شروع آزمون" %}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Question Panels (grouped) -->
            {% for grp in question_groups %}
              <div x-show="started && current === {{ forloop.counter0 }}" x-trap.noscroll.inert="started && current === {{ forloop.counter0 }}" aria-live="polite">
                <div class="card mb-3 border-0 shadow-sm">
                  <div class="card-body">
                    <div class="d-flex align-items-start gap-2 mb-2">
                      <span class="badge bg-primary-subtle text-primary">{{ forloop.counter }}</span>
                      <label class="form-label m-0">{{ grp.question.text }}</label>
                    </div>
                    <div class="mt-2">
                      {% for field in grp.fields %}
                        <div class="mb-2">{{ field }}</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                  <button type="button" class="btn btn-light border" @click="prev()" :disabled="current===0">
                    <i class="fas fa-arrow-right me-1"></i>{% trans "قبلی" %}
                  </button>
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" @click="next(total)" x-show="current < total - 1">
                      {% trans "بعدی" %}<i class="fas fa-arrow-left ms-1"></i>
                    </button>
                    <button class="btn btn-success" x-show="current === total - 1">
                      <i class="fas fa-check me-1"></i>{% trans "ثبت پاسخ‌ها" %}
                    </button>
                  </div>
                </div>
              </div>
            {% endfor %}
          </form>
          
          <!-- Keyboard hints -->
          <div class="text-muted small mt-4">
            <i class="fas fa-keyboard me-1"></i>
            {% trans "می‌توانید با کلیدهای \"جهت‌چپ\" و \"جهت‌راست\" بین سوال‌ها جابه‌جا شوید." %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function quiz(){
  return {
    started: {{ started_initial|yesno:"true,false" }},
    showIdentity: {{ show_identity_form|yesno:"true,false" }},
    current: 0,
    total: {{ question_groups|length|default:0 }},
    errors: { fullName: false, email: false },
    get progress(){
      if(!this.started || this.total === 0) return 0;
      return Math.round(((this.current+1)/Math.max(this.total,1))*100);
    },
    start(){
      this.errors.fullName = false;
      this.errors.email = false;
      const nameInput = document.querySelector('[name=\"full_name\"]');
      const emailInput = document.querySelector('[name=\"email\"]');
      const nameVal = (nameInput?.value || '').trim();
      const emailVal = (emailInput?.value || '').trim();
      if(!nameVal){ this.errors.fullName = true; }
      const emailOk = /^\S+@\S+\.\S+$/.test(emailVal);
      if(!emailOk){ this.errors.email = true; }
      if(this.errors.fullName || this.errors.email){ return; }
      this.started = true;
      this.scrollToTop();
    },
    next(){ if(!this.started) return; if(this.current < this.total-1) { this.current++; this.scrollToTop(); } },
    prev(){ if(!this.started) return; if(this.current>0) { this.current--; this.scrollToTop(); } },
    scrollToTop(){ try { document.querySelector('.card-body').scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e){} }
  }
}
// Keyboard navigation
document.addEventListener('keydown', function(e){
  const root = document.querySelector('[x-data\\=\"quiz()\"]');
  if(!root) return;
  const comp = Alpine && Alpine.$data(root);
  if(!comp) return;
  if(!comp.started) return;
  if(e.key === 'ArrowLeft'){ e.preventDefault(); comp.next(); }
  if(e.key === 'ArrowRight'){ e.preventDefault(); comp.prev(); }
});
</script>
{% endblock %}


